<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Music Renamer (Editable)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
    button { margin-right: 1rem; margin-bottom: 1rem; padding:.5rem 1rem; }
    input[type="text"] { width: 98%; padding:.3rem .4rem; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; }
    th, td { padding:8px; border-bottom:1px solid #ccc; }
    th { background:#eee; text-align:left; }
    pre { background:#111; color:#0f0; padding:1rem; border-radius:6px; }
    .danger { background:#8b0000; color:#fff; }
    .small { font-size:.8rem; color:#666; }
  </style>
</head>
<body>

<h1>Music Renamer</h1>

<div class="row">
  <button onclick="scan()">Scan</button>
  <button onclick="preview()">Preview rename</button>
  <button onclick="applyRename()">Apply rename</button>
</div>

<h3>Delete files</h3>
<textarea id="delpaths" rows="3" style="width:100%;"></textarea><br/>
<button class="danger" onclick="doDelete()">Delete</button>

<h3>Items</h3>
<table id="tbl">
  <thead>
    <tr>
      <th>File</th>
      <th>Artist (editable)</th>
      <th>Title (editable)</th>
      <th>Ext</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Output</h3>
<pre id="out"></pre>

<script>

let CURRENT_ITEMS = [];

async function call(url, body) {
  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body || {})
  });
  return await res.json();
}

function setOut(obj) {
  document.getElementById('out').textContent =
    (obj.ok ? "OK\n\n" : "ERROR\n\n") +
    JSON.stringify(obj, null, 2);
}

function renderItems(items) {
  CURRENT_ITEMS = items;
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = "";

  for (let i=0; i<items.length; i++) {
    const it = items[i];
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td>${it.rel || it.path}</td>
      <td><input type="text" value="${it.artist || ""}" data-idx="${i}" data-field="artist"/></td>
      <td><input type="text" value="${it.title || ""}"  data-idx="${i}" data-field="title"/></td>
      <td>${it.ext}</td>
    `;
    tb.appendChild(tr);
  }

  // listen to edits
  document.querySelectorAll("input[data-idx]").forEach(inp=>{
    inp.addEventListener("input", e=>{
      const idx = e.target.getAttribute("data-idx");
      const fld = e.target.getAttribute("data-field");
      CURRENT_ITEMS[idx][fld] = e.target.value;
    });
  });
}

async function scan() {
  const j = await call('/api/scan', {});
  if (j.ok) renderItems(j.items);
  setOut(j);
}

async function preview() {
  const j = await call('/api/preview', { items: CURRENT_ITEMS });
  setOut(j);
}

async function applyRename() {
  const j = await call('/api/apply', { items: CURRENT_ITEMS });
  setOut(j);
  await scan();
}

async function doDelete() {
  const raw = document.getElementById('delpaths').value.trim();
  const paths = raw ? raw.split(/\r?\n/) : [];
  const j = await call('/api/delete', { paths });
  setOut(j);
  await scan();
}

scan();

</script>
</body>
</html>